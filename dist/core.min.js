var app,$$,mainView;window.onload=function(){modeCordova?(document.addEventListener("deviceready",lemurro.init),document.addEventListener("offline",lemurro.internet.offline),document.addEventListener("online",lemurro.internet.online)):lemurro.init()};var lemurro={};lemurro.sessionID="",lemurro.settings={},lemurro.f7settings={},lemurro.init=function(){void 0===window.overrideSettings&&(window.overrideSettings={}),void 0===window.overrideF7Settings&&(window.overrideF7Settings={}),lemurro.settings=Object.assign({versionAPI:1,authType:"email",pageAfterAuth:"/home",marketiOS:"https://itunes.apple.com/us/app/lemurro/id0000000000?l=ru&ls=1&mt=8",marketAndroid:"market://details?id=ru.bestion.lemurro",onLoad:function(e){var r=Template7.compile($$("#js-tpl-user__info").html());$$("#js-user_info").html(r(e))}},window.overrideSettings),lemurro.f7settings=Object.assign({id:"ru.bestion.lemurro",name:"Lemurro",version:"0.1.0",theme:"md",root:"#app",panel:{swipe:"both"},touch:{fastClicks:!1},on:{pageInit:function(e){app.panel.close(),lemurro._initPage(e.name)}},routes:[{path:"/about",url:"./pages/about.html"},{path:"/home",url:"./pages/home.html"}]},window.overrideF7Settings),lemurro._bindJSerrors(),app=new Framework7(lemurro.f7settings),$$=Dom7,mainView=app.views.create(".view-main"),$$("#js-api-version").text(lemurro.settings.versionAPI),lemurro._showLoginScreen(),app.request.setup({cache:!1,crossDomain:!0,timeout:2e4,beforeSend:function(e){e.requestUrl.substr(0,pathServerAPI.length)===pathServerAPI&&(e.requestParameters.dataType="json",e.setRequestHeader("X-SESSION-ID",lemurro.sessionID))},error:function(e,r){app.preloader.hide();var o="Неизвестная ошибка";switch(r){case"timeout":o="Время ожидания истекло";break;case"parsererror":o="Ошибка парсера";break;case"abort":o="Запрос был отменён";break;case"error":o="Произошла ошибка сервера"}app.dialog.alert(o,"Ошибка запроса")}}),lemurro._run()},lemurro._bindCodeMask=function(){$$(".js-code-mask").each(function(){var e=$$(this);Inputmask({mask:"9999"}).mask(e)})},lemurro._bindExternalLink=function(){$$(document).on("click",'a[target="_blank"]',function(e){return window.open($$(this).attr("href"),"_system"),e.preventDefault(),!1})},lemurro._bindJSerrors=function(){function e(e,r,o,t,n){var i="JSON not found";window.JSON&&(i=JSON.stringify(n)),"object"==typeof e&&(r=e.filename,o=e.lineno,t=e.colno,i=e.error.stack,e=e.message),(new Image).src=pathServerAPI+"jserrors?msg="+encodeURIComponent(e)+"&file="+encodeURIComponent(r)+"&line="+encodeURIComponent(o)+"&col="+encodeURIComponent(t)+"&err="+encodeURIComponent(i)}window.addEventListener?window.addEventListener("error",e,!1):window.attachEvent?window.attachEvent("onerror",e):window.onerror=e},lemurro._bindPhoneMask=function(){$$(".js-phone-mask").each(function(){var e=$$(this);Inputmask({mask:"+7 (999) 999-99-99"}).mask(e)})},lemurro._bindShowPopover=function(){$$("body").on("click",".js-show-popover",function(){app.dialog.alert($$(this).attr("data-popover"),"")})},lemurro._initPage=function(e){app.preloader.show(),app.request.get(pathServerAPI+"user",{},function(r){if(app.preloader.hide(),r.hasOwnProperty("errors"))lemurro.showErrors(r.errors);else{lemurro.settings.onLoad(r.data);var o=window[e];void 0!==o&&o.hasOwnProperty("init")&&o.init()}})},lemurro._run=function(){app.preloader.show(),app.request.get(pathServerAPI,{},function(e){if(app.preloader.hide(),e.hasOwnProperty("errors"))lemurro.showErrors(e.errors);else if(modeCordova&&parseInt(e.data.version[device.platform.toLowerCase()],10)>lemurro.settings.versionAPI){var r=$$("#js-popup");r.find(".popup__title").html("&nbsp;"),r.find(".popup__content").html('<div class="text-align-center"><h1><i class="fas fa-thumbs-up font-100"></i></h1><h1>Ура, вышла новая версия приложения!</h1><h3>Чтобы продолжить, обновите приложение из магазина.</h3><p><a href="javascript:lemurro.update();" class="button button-raised button-fill">Обновить</a></p></div>'),r.find(".close-popup").hide(),app.popup.open(r)}else lemurro._bindShowPopover(),lemurro._bindPhoneMask(),lemurro._bindCodeMask(),lemurro._bindExternalLink(),localforage.getItem("sessionID",function(e,r){lemurro.sessionID=r,null!==lemurro.sessionID&&lemurro.auth.check()})})},lemurro._showLoginScreen=function(){$$("#js-login-screen .js-auth-form").hide(),$$("#js-auth-"+lemurro.settings.authType+"-get-form").show(),app.loginScreen.open("#js-login-screen")},lemurro.showErrors=function(e){if(1===e.length&&"401 Unauthorized"===e[0].status)lemurro._showLoginScreen();else for(var r in e){var o=e[r],t="";switch(o.code){case"danger":t="Критическая ошибка";break;case"warning":t="Внимание!";break;case"info":t="Информация"}app.dialog.alert(o.title,t)}},lemurro.update=function(){var r="market"+device.platform;return modeCordova&&lemurro.settings.hasOwnProperty(r)?(window.open(lemurro.settings[r],"_system"),e.preventDefault()):app.dialog.alert('Здесь должна быть ссылка на магазин "'+device.platform+'"',"Магазин"),!1},lemurro.auth={},lemurro.auth._timerID=null,lemurro.auth._runTimer=function(){null!==lemurro.auth._timerID&&clearInterval(lemurro.auth._timerID),lemurro.auth._timerID=setInterval(function(){var e=$$("#js-auth-"+lemurro.settings.authType+"-check-form"),r=e.find(".js-timer__count"),o=parseInt(r.text(),10);o>0?r.text(--o):(clearInterval(lemurro.auth._timerID),e.find(".js-timer").hide(),e.find(".js-resend").show())},1e3)},lemurro.auth.check=function(){app.preloader.show(),app.request.get(pathServerAPI+"auth/check",{},function(e){app.preloader.hide(),e.hasOwnProperty("errors")?(localforage.clear(),lemurro.sessionID=""):(app.loginScreen.close("#js-login-screen"),app.router.navigate(lemurro.settings.pageAfterAuth))})},lemurro.auth.checkCode=function(){var e={uuid:"q1w2e3r4t5y6u7i8o9p0",platform:"TestOS",version:"1.0",manufacturer:"Samsung",model:"Galaxy S8"};modeCordova&&(e={uuid:device.uuid,platform:device.platform,version:device.version,manufacturer:device.manufacturer,model:device.model}),app.preloader.show(),app.request.post(pathServerAPI+"auth/code",{auth_id:$$("#js-auth-"+lemurro.settings.authType+"-get-form").find('input[name="auth_id"]').val(),auth_code:$$("#js-auth-"+lemurro.settings.authType+"-check-form").find('input[name="auth_code"]').val(),device_info:e},function(e){app.preloader.hide(),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):localforage.setItem("sessionID",e.data.session,function(){Deferred.next(function(){lemurro.sessionID=e.data.session}).next(function(){app.loginScreen.close("#js-login-screen"),app.router.navigate(lemurro.settings.pageAfterAuth)})})})},lemurro.auth.getCode=function(){app.preloader.show(),app.request.get(pathServerAPI+"auth/code",{auth_id:$$("#js-auth-"+lemurro.settings.authType+"-get-form").find('input[name="auth_id"]').val()},function(e){if(app.preloader.hide(),e.hasOwnProperty("errors"))lemurro.showErrors(e.errors);else{var r=$$("#js-auth-"+lemurro.settings.authType+"-check-form");r.find(".js-timer").show(),r.find(".js-timer__count").text("60"),r.find(".js-resend").hide(),lemurro.auth._runTimer(),$$("#js-auth-"+lemurro.settings.authType+"-get-form").hide(),r.show()}})},lemurro.helper={},lemurro.helper.showConfirm=function(e,r,o,t,n,i,a,s){swal({title:e,html:r,type:"",allowOutsideClick:!1,showCancelButton:!0,confirmButtonColor:"#2196f3",confirmButtonText:o,cancelButtonText:t,onOpen:n,preConfirm:i}).then(function(){a()},function(e){""!==e&&null!==s&&s()})},lemurro.helper.showPopup=function(e,r){var o=$$("#js-popup");o.find(".popup__title").html(e),o.find(".popup__content").html(r),app.popup.open(o)},lemurro.internet={},lemurro.internet.offline=function(){app.dialog.preloader("Пропал интернет,<br>надо вернуть.")},lemurro.internet.online=function(){app.dialog.close()};